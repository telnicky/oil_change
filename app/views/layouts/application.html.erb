<!DOCTYPE html>
<html lang="en">
<head>
    <%= stylesheet_link_tag    "application", :media => "all" %>
  <%= javascript_include_tag "application" %>
  <%#= javascript_include_tag :defaults %>
  <%= javascript_include_tag 'rails' %>
  <%= csrf_meta_tags %>
  <!-- START GOOGLE MAPS API -->
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <style type="text/css">
    #map_canvas { height: 350px; width: 80%; }
    .map_canvas { height: 350px; width: 720px; }
  </style>
  
  <%= javascript_include_tag 'http://maps.googleapis.com/maps/api/js?key=AIzaSyAJXNiTBM1wkZZFwwSM3dB1IyPAqed69_E&sensor=true' %>
  <script type="text/javascript">
    var latlng = new google.maps.LatLng(40.303467, -111.66164);
    var map;

    function initialize() {
        var mapOptions = {
          zoom: 12,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById('map_canvas'),
            mapOptions);

        // Try HTML5 geolocation
        if(navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = new google.maps.LatLng(position.coords.latitude,
                                             position.coords.longitude);

            /*var infowindow = new google.maps.InfoWindow({
              map: map,
              position: pos,
              content: "We found your approximate location. \n Use the fields above to schedule the exact location of your oil change."
            }); */

            map.setCenter(pos);
          }, function() {
            handleNoGeolocation(true);
          });
        } else {
          // Browser doesn't support Geolocation
          handleNoGeolocation(false);
        }
      }

      function handleNoGeolocation(errorFlag) {
        if (errorFlag) {
          var content = 'Error: The Geolocation service was not properly initialized.';
        } else {
          var content = 'Error: Your browser doesn\'t support geolocation.';
        }

        var options = {
          map: map,
          position: new google.maps.LatLng(60, 105),
          content: content
        };

        var infowindow = new google.maps.InfoWindow(options);
        map.setCenter(options.position);
      }

      google.maps.event.addDomListener(window, 'load', initialize);
//
//code to change map to input location
//
    $(function(){ 
      function getNewLatLng() {
        var address = ($('#street').val() || "") + " " + ($('#city').val() || "") + " " +  ($('#zip').val() || "");
        var geocoder = new google.maps.Geocoder();
       
        var geo = geocoder.geocode({'address' : address}, function(results, status){
            if (status == google.maps.GeocoderStatus.OK) {
              //collect lat and lng set to x and y, respectively
              var newX = results[0].geometry.location.Xa;
              var newY = results[0].geometry.location.Ya;
                
              //render the map.
              map.setCenter(new google.maps.LatLng(newX, newY));
             
              //add new point & window to map or update existing point         
               console.log(appMarker + " before")         
              if ( check !== "1") {
                 console.log(appMarker + 'if')
                //add point to map.
                var appMarker = new google.maps.Marker({
                  position: results[0].geometry.location,
                  map: map,
                  zoom: 4,
                  title: 'Your appointment location!',
                });
                console.log(check)
                var check = "1";
                console.log(check)
                //update window
                var windowBox = new google.maps.InfoWindow({
                      map: map,
                      position: results[0].geometry.location,
                      content: 'Your vehicle\'s location'
                    });
              } else if ( check == "1") { 
               console.log(appMarker + 'else')
                //Just Update the Marker position
                appMarker.setPosition( results[0].geometry.location );
                 //update window
                windowBox.setPosition( results[0].geometry.location ); 
              } //if ( marker ) END
                                        
            } else {
              alert("Geocode was not successful for the following reason: " + status);
            }
          }); //var geo = geocoder.... END
        }; //getNewLatLng END
       
      $('#zip').change(getNewLatLng);
      $('#city').change(getNewLatLng);
      $('#street').change(getNewLatLng);
    
    });  //$(function(){ END
    </script>
  <!-- END GOOGLE MAPS API -->

  <title>Mobile Oil Change</title>

</head>
<body>
  <header>
    <div class="header"> 
      <div class="headerBody">
        <img src="/assets/car.png" />
        <h3>Mobile Oil Change</h3> 
        <div class="userInfo"> 
          <% if(owner_signed_in?) %>
            <%= link_to("#{current_owner.first_name} #{current_owner.last_name}", owner_path(current_owner)) %> |
            <%= link_to 'Log Out', destroy_owner_session_path, :method => :delete %> <br/> 
          <% elsif(mechanic_signed_in?) %>
            <%= link_to("#{current_mechanic.first_name} #{current_mechanic.last_name}", mechanic_path(current_mechanic)) %> |
            <%= link_to 'Log Out', destroy_mechanic_session_path, :method => :delete %> <br/> 
          <% else %>  
            <%= yield :login %>
          <% end %>
          <%= DateTime.now.strftime('%A, %B %d - %I:%M %p') %>
        </div>
      </div>  
    </div>
  </header>
 
  <div class="flash-header">
    <% if flash[:notice] %>
      <p class="notice"><%= flash[:notice] %></p>
    <% end %>
    <% if flash[:error] %>
      <p class="error"><%= flash[:error] %></p>
    <% end %>
  </div>

  <div id="yield">
    <%= yield %>
  </div>
  

 <!-- <footer>
    <div class="footer">
      <div class="footerBody">
        All rights reserved 2012 
      </div>
    </div>
  </footer> -->
</body>
</html>
